// src/pages/Home.jsx
import React, { useEffect, useRef, useState } from "react";
import { Link } from "react-router-dom";
import "../styles/Home.css";

export default function Home() {
  /* -------------------- Animated counters -------------------- */
  const [stats, setStats] = useState({ schemes: 0, jobs: 0, farmers: 0 });
  useEffect(() => {
    const t = setInterval(() => {
      setStats((p) => ({
        schemes: Math.min(500, p.schemes + 10),
        jobs: Math.min(1000, p.jobs + 20),
        farmers: Math.min(50000, p.farmers + 1200),
      }));
    }, 45);
    return () => clearInterval(t);
  }, []);

  /* -------------------- Reveal on scroll --------------------- */
  useEffect(() => {
    const els = document.querySelectorAll("[data-reveal]");
    const obs = new IntersectionObserver(
      (entries) =>
        entries.forEach((e) => {
          if (e.isIntersecting) e.target.classList.add("reveal--on");
        }),
      { threshold: 0.12 }
    );
    els.forEach((el) => obs.observe(el));
    return () => obs.disconnect();
  }, []);

  /* -------------------- Modal / Weather ---------------------- */
  const [modal, setModal] = useState({ open: false, title: "", type: "" });
  const [weather, setWeather] = useState(null); // { temp, condition, humidity, city } | {error} | null

  // Accepts lat/lon; if not provided, falls back to Delhi
  const fetchWeather = async (lat, lon) => {
    try {
      const API_KEY = import.meta.env.VITE_WEATHER_KEY;
      if (!API_KEY) throw new Error("Missing API key");

      let url = "";
      if (lat != null && lon != null) {
        url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=hi`;
      } else {
        // Fallback Delhi
        url = `https://api.openweathermap.org/data/2.5/weather?q=Delhi&appid=${API_KEY}&units=metric&lang=hi`;
      }

      const res = await fetch(url);
      const data = await res.json();

      if (data.cod !== 200) throw new Error(data.message || "API error");

      setWeather({
        temp: Math.round(data.main.temp),
        condition: data.weather?.[0]?.description || "‚Äî",
        humidity: data.main.humidity,
        city: data.name,
      });
    } catch (e) {
      setWeather({ error: "Weather info not available" });
    }
  };

  const openModal = (title, type = "normal") => {
    setModal({ open: true, title, type });
    if (type === "weather") {
      setWeather(null); // reset state
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            fetchWeather(latitude, longitude);
          },
          () => fetchWeather(), // fallback (Delhi)
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
        );
      } else {
        fetchWeather(); // fallback (Delhi)
      }
    }
  };

  const closeModal = () => {
    setModal({ open: false, title: "", type: "" });
    setWeather(null);
  };

  /* -------------------- Services data (ordered) -------------------- */
  const items = [
    {
      id: "weather",
      title: "Weather Info",
      desc: "Get the latest weather updates for your region",
      footer: "Check Weather",
      icon: "üå¶Ô∏è",
      color: "peach",
      type: "weather",
    },
    {
      id: "calc",
      title: "Insurance Premium Calculator",
      desc: "Know your insurance premium before",
      footer: "Calculate",
      icon: "üßÆ",
      color: "green",
    },
    {
      id: "farmer",
      title: "Farmer Corner",
      desc: "Apply for Crop Insurance Yourself",
      footer: "Farmer Corner",
      icon: "üìÑ",
      color: "aqua",
    },
  ];

  /* -------------------- Carousel helpers -------------------- */
  const railRef = useRef(null);
  const step = () =>
    (railRef.current?.querySelector(".service-card")?.clientWidth || 300) + 28;
  const scrollBy = (dir) =>
    railRef.current?.scrollBy({ left: dir * step(), behavior: "smooth" });

  /* ======================== UI =============================== */
  return (
    <main className="landing">
      {/* =============== HERO ================= */}
      <section className="hero">
        <div className="hero__overlay">
          <div className="hero__badge">‡§ï‡§ø‡§∏‡§æ‡§®-‡§π‡§ø‡§§ ‡§™‡•ç‡§≤‡•á‡§ü‡§´‡§º‡•â‡§∞‡•ç‡§Æ</div>

          <h1 className="hero__title">
            ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç ‡§î‡§∞ <br />
            <span>‡§®‡•å‡§ï‡§∞‡•Ä ‡§ï‡•á ‡§Ö‡§µ‡§∏‡§∞ ‚Äî ‡§è‡§ï ‡§π‡•Ä ‡§ú‡§ó‡§π</span>
          </h1>

          <p className="hero__subtitle">
            ‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§î‡§∞ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§ï‡•Ä 500+ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç, 1000+ ‡§ú‡•â‡§¨‡•ç‡§∏, ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ, ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º
            ‡§î‡§∞ ‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü apply ‡§≤‡§ø‡§Ç‡§ï ‚Äî ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§Ü‡§∏‡§æ‡§® ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç‡•§
          </p>
          <p className="hero__trust">‡§µ‡§ø‡§∂‡•ç‡§µ‡§∏‡§®‡•Ä‡§Ø ‡§∏‡•ç‡§∞‡•ã‡§§ ‚Ä¢ ‡§´‡•ç‡§∞‡•Ä ‡§Ö‡§™‡§°‡•á‡§ü‡•ç‡§∏ ‚Ä¢ ‡§¨‡§ø‡§®‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§¢‡§º‡•á‡§Ç</p>

          <div className="hero__actions">
            <Link to="/schemes" className="btn btn--solid" aria-label="Explore schemes">
              ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç ‡§¶‡•á‡§ñ‡•á‡§Ç ‚Üí
            </Link>
            <Link to="/jobs" className="btn btn--outlineDark" aria-label="Find jobs">
              ‡§®‡•å‡§ï‡§∞‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç
            </Link>
          </div>
        </div>

        <div className="stats">
          <div className="stat">
            <div className="stat__num">{stats.schemes}+</div>
            <div className="stat__label">‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç</div>
          </div>
          <div className="stat">
            <div className="stat__num">{stats.jobs}+</div>
            <div className="stat__label">‡§®‡•å‡§ï‡§∞‡•Ä ‡§ï‡•á ‡§Ö‡§µ‡§∏‡§∞</div>
          </div>
          <div className="stat">
            <div className="stat__num">{stats.farmers.toLocaleString()}+</div>
            <div className="stat__label">‡§≤‡§æ‡§≠‡§æ‡§∞‡•ç‡§•‡•Ä ‡§ï‡§ø‡§∏‡§æ‡§®</div>
          </div>
        </div>
      </section>

      {/* =============== SERVICES ================= */}
      <section className="services" data-reveal>
        <h2 className="section-title">‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç</h2>
        <p className="section-sub">‡§∏‡§¨‡§∏‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§ü‡•Ç‡§≤‡•ç‡§∏ ‡§ú‡•ã ‡§Ü‡§™‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§æ‡§§‡•á ‡§π‡•à‡§Ç</p>

        <div className="carousel">
          <div className="carousel__fade carousel__fade--left" aria-hidden />
          <div className="carousel__fade carousel__fade--right" aria-hidden />

          <button
            className="carousel__arrow carousel__arrow--left"
            onClick={() => scrollBy(-1)}
            aria-label="scroll left"
          >
            ‚Äπ
          </button>

          <div className="carousel__rail" ref={railRef}>
            {items.map((s) => (
              <article
                key={s.id}
                className={`service-card service-card--${s.color}`}
                role="button"
                tabIndex={0}
                onClick={() => openModal(s.title, s.type)}
                onKeyDown={(e) => e.key === "Enter" && openModal(s.title, s.type)}
              >
                <div className="service-card__icon">{s.icon}</div>
                <h3 className="service-card__title">{s.title}</h3>
                <p className="service-card__desc">{s.desc}</p>
                <div className="service-card__footer">{s.footer}</div>
              </article>
            ))}
          </div>

          <button
            className="carousel__arrow carousel__arrow--right"
            onClick={() => scrollBy(1)}
            aria-label="scroll right"
          >
            ‚Ä∫
          </button>
        </div>
      </section>

      {/* =============== MODAL ================= */}
      {modal.open && (
        <div className="modal" onClick={closeModal} role="dialog" aria-modal="true">
          <div className="modal__card" onClick={(e) => e.stopPropagation()}>
            <button className="modal__close" onClick={closeModal} aria-label="Close">
              √ó
            </button>

            {modal.type === "weather" ? (
              <>
                <div className="modal__icon">üå¶Ô∏è</div>
                <h3 className="modal__title">Weather Info</h3>

                {weather ? (
                  weather.error ? (
                    <p className="modal__desc">{weather.error}</p>
                  ) : (
                    <div className="weather-card">
                      <div className="weather-card__city">üìç {weather.city}</div>
                      <div className="weather-card__temp">{weather.temp}¬∞C</div>
                      <div className="weather-card__condition">‚òÅÔ∏è {weather.condition}</div>
                      <div className="weather-card__extra">
                        üíß Humidity: <strong>{weather.humidity}%</strong>
                      </div>
                    </div>
                  )
                ) : (
                  <p className="modal__desc">Loading weather...</p>
                )}
              </>
            ) : (
              <>
                <div className="modal__icon">üöß</div>
                <h3 className="modal__title">Feature coming soon</h3>
                <p className="modal__desc">
                  <strong>{modal.title}</strong> ‡§Ö‡§≠‡•Ä ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§Æ‡•á‡§Ç ‡§π‡•à‡•§ ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§á‡§∏‡•á ‡§≤‡•â‡§®‡•ç‡§ö ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
                </p>
              </>
            )}

            <button className="btn btn--solid" onClick={closeModal}>
              ‡§†‡•Ä‡§ï ‡§π‡•à
            </button>
          </div>
        </div>
      )}

      {/* =============== FEATURES ================= */}
      <section className="features" data-reveal>
        <h2 className="section-title">‡§ï‡•ç‡§Ø‡•ã‡§Ç ‡§ö‡•Å‡§®‡•á‡§Ç ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤?</h2>
        <div className="features__grid">
          <div className="feature-tile">‚úÖ ‡§Ü‡§∏‡§æ‡§® ‡§™‡§π‡•Å‡§Ç‡§ö</div>
          <div className="feature-tile">üìã ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§ú‡•â‡§¨‡•ç‡§∏</div>
          <div className="feature-tile">‚è∞ 24/7 ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü</div>
          <div className="feature-tile">‚ö° ‡§§‡•á‡§ú‡§º ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ</div>
        </div>
      </section>

      {/* =============== CTA ================= */}
      {/* =============== CTA ================= */}
<section className="cta cta--glass" data-reveal>
  <div className="cta__wrap">
    <h3 className="cta__title">‡§Ü‡§ú ‡§π‡•Ä ‡§Ö‡§™‡§®‡•á ‡§Ö‡§ó‡§≤‡•á ‡§ï‡§¶‡§Æ ‡§§‡§Ø ‡§ï‡§∞‡•á‡§Ç</h3>

    <p className="cta__lead">
      ‡§Ö‡§™‡§®‡•Ä <strong>eligibility</strong> ‡§∏‡§Æ‡§ù‡•á‡§Ç, ‡§∏‡§π‡•Ä ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§∞‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç ‚Äî 
      ‡§π‡§Æ ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç verified ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§î‡§∞ direct links‡•§
    </p>

    <ul className="cta__benefits">
      <li>‚úÖ ‡§∞‡§ø‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü‡•ç‡§∏ ‡§î‡§∞ ‡§®‡•ã‡§ü‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§®</li>
      <li>‚úÖ ‡§∏‡•ç‡§ü‡•á‡§ü-‡§µ‡§æ‡§á‡§ú‡§º / ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä-‡§µ‡§æ‡§á‡§ú‡§º ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞</li>
      <li>‚úÖ ‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ ‡§ï‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§≤‡§ø‡§Ç‡§ï</li>
    </ul>

    <div className="cta__actions">
      {/* NOTE: use Links to your routes */}
      <Link to="/schemes" className="btn cta-btn cta-btn--primary btn--lg" aria-label="Explore Schemes">
        <span className="btn__icon" aria-hidden>üìë</span>
        <span>Explore Schemes ‚Üí</span>
      </Link>

      <Link to="/jobs" className="btn cta-btn cta-btn--outline btn--lg" aria-label="Find Jobs">
        <span className="btn__icon" aria-hidden>üíº</span>
        <span>Find Jobs</span>
      </Link>
    </div>
  </div>
</section>

    </main>
  );
}
